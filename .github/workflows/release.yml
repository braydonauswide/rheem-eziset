name: "Release"

on:
  release:
    types:
      - "published"

permissions: {}

jobs:
  release:
    name: "Release"
    runs-on: "ubuntu-latest"
    permissions:
      contents: write
    steps:
      - name: "Checkout the repository"
        uses: "actions/checkout@v4.1.7"

      - name: "Update version in all files"
        shell: "bash"
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          # Allow tags like v1.2.3, but write a clean semver
          VERSION="${VERSION#v}"
          python3 scripts/update_version.py "${VERSION}"

      - name: "Commit version updates"
        shell: "bash"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No version changes to commit"
          else
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
            git commit -m "Bump version to ${VERSION}"
            git push origin main
          fi

      - name: "ZIP the integration directory"
        shell: "bash"
        run: |
          cd "${{ github.workspace }}/custom_components/rheem_eziset"
          zip rheem_eziset.zip -r ./

      - name: "Upload the ZIP file to the release"
        uses: softprops/action-gh-release@v2.0.6
        with:
          files: ${{ github.workspace }}/custom_components/rheem_eziset/rheem_eziset.zip
