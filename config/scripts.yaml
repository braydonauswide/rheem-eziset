# End bath: try API cancel via Bath Fill switch, then fallback to hot water power switch.
# Call with variables: bath_fill_entity_id (e.g. switch.rheem_eziset_xxxx_bath_fill),
# hot_water_switch_entity_id (e.g. switch.rheem_hot_water). Leave hot_water_switch_entity_id
# empty to skip power fallback. Find Bath Fill entity_id in Developer Tools > States or device card.
end_bath_with_fallback:
  alias: "End Bath (with fallback)"
  description: "Turn off bath fill via API; if still on after delay, power off hot water unit then restore power."
  variables:
    bath_fill_entity_id: ""
    hot_water_switch_entity_id: ""
  mode: restart
  sequence:
    # Step 1: Turn off Bath Fill switch (sends API cancel) only if entity_id provided
    - choose:
        - conditions: "{{ bath_fill_entity_id | length > 0 }}"
          sequence:
            - action: switch.turn_off
              target:
                entity_id: "{{ bath_fill_entity_id }}"
    # Step 2: Wait for API cancel to complete or timeout
    - delay:
        seconds: 20
    # Step 3 (fallback): If Bath Fill still on or unavailable and hot water switch set, power off then on
    - choose:
        - conditions: "{{ (bath_fill_entity_id | length > 0) and (is_state(bath_fill_entity_id, 'on') or is_state(bath_fill_entity_id, 'unavailable')) and (hot_water_switch_entity_id | length > 0) }}"
          sequence:
            - action: switch.turn_off
              target:
                entity_id: "{{ hot_water_switch_entity_id }}"
            - delay:
                seconds: 8
            - action: switch.turn_on
              target:
                entity_id: "{{ hot_water_switch_entity_id }}"
